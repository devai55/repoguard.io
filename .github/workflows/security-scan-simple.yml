name: Security Scan (Simple)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install RepoGuard CLI
      run: pip install repoguard-cli

    - name: Run RepoGuard Security Scan
      id: scan
      continue-on-error: true
      run: |
        set +e
        repoguard scan --repo . --format json
        exit_code=$?
        echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        # Check if report was generated
        if [ -f repoguard-report.json ]; then
          echo "report_exists=true" >> $GITHUB_OUTPUT
          cat repoguard-report.json
        else
          echo "report_exists=false" >> $GITHUB_OUTPUT
          echo "No report generated - scan may have hit free tier limit"
        fi
        exit 0

    - name: Parse Results
      id: parse
      if: steps.scan.outputs.report_exists == 'true'
      run: |
        critical=$(jq '.scan_statistics.issues_critical // 0' repoguard-report.json)
        high=$(jq '.scan_statistics.issues_high // 0' repoguard-report.json)
        medium=$(jq '.scan_statistics.issues_medium // 0' repoguard-report.json)
        total=$(jq '.scan_statistics.total_issues // 0' repoguard-report.json)
        risk_level=$(jq -r '.scan_statistics.risk_level // "UNKNOWN"' repoguard-report.json)
        
        echo "critical=$critical" >> $GITHUB_OUTPUT
        echo "high=$high" >> $GITHUB_OUTPUT
        echo "medium=$medium" >> $GITHUB_OUTPUT
        echo "total=$total" >> $GITHUB_OUTPUT
        echo "risk_level=$risk_level" >> $GITHUB_OUTPUT

    - name: Upload Security Report
      if: steps.scan.outputs.report_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: repoguard-report.json
        retention-days: 30

    - name: Comment on PR (Success)
      if: github.event_name == 'pull_request' && steps.scan.outputs.report_exists == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const critical = '${{ steps.parse.outputs.critical }}' || '0';
          const high = '${{ steps.parse.outputs.high }}' || '0';
          const medium = '${{ steps.parse.outputs.medium }}' || '0';
          const total = '${{ steps.parse.outputs.total }}' || '0';
          const risk_level = '${{ steps.parse.outputs.risk_level }}' || 'UNKNOWN';
          
          let emoji = 'âœ…';
          if (risk_level === 'CRITICAL') emoji = 'ðŸš¨';
          else if (risk_level === 'HIGH') emoji = 'âš ï¸';
          else if (parseInt(total) > 0) emoji = 'ðŸ”';
          
          const body = `## ${emoji} RepoGuard Security Scan Results
          
**Risk Level:** ${risk_level}
**Total Issues:** ${total}

### Breakdown:
- ðŸ”´ Critical: ${critical}
- ðŸŸ  High: ${high}
- ðŸŸ¡ Medium: ${medium}

${parseInt(critical) > 0 ? '**âš ï¸ CRITICAL issues found - Review required!**' : parseInt(total) > 0 ? '**Security issues detected - Review recommended**' : '**âœ… No critical security issues found!**'}

ðŸ“Š [View detailed report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})

---
*Scanned by [RepoGuard](https://repoguard.dev)*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Comment on PR (Scan Limited)
      if: github.event_name == 'pull_request' && steps.scan.outputs.report_exists != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const body = `## âš ï¸ RepoGuard Security Scan
          
**Status:** Scan limit reached

The free tier limit (10 scans/month) has been reached. 

### Options:
- ðŸ”‘ Add a RepoGuard Pro license for unlimited scans
- â° Wait until next month for free tier reset
- ðŸ”§ Run scan locally: \`repoguard scan --repo .\`

---
*[RepoGuard](https://repoguard.dev) - Automated security scanning*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Security Summary
      if: always()
      run: |
        echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.scan.outputs.report_exists }}" == "true" ]; then
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Risk Level | ${{ steps.parse.outputs.risk_level }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Issues | ${{ steps.parse.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | ${{ steps.parse.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| High | ${{ steps.parse.outputs.high }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium | ${{ steps.parse.outputs.medium }} |" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Scan did not complete - free tier limit may have been reached" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Fail on Critical Issues
      if: steps.scan.outputs.report_exists == 'true' && steps.parse.outputs.risk_level == 'CRITICAL'
      run: |
        echo "ðŸš¨ CRITICAL security issues detected!"
        echo "Review the security report and fix issues before merging."
        exit 1