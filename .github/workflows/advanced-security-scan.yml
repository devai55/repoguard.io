name: Advanced Security Scan with RepoGuard

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - '**/*.py'      # Only scan Python files
      - '**/*.js'      # Only scan JavaScript files
      - '**/*.ts'      # Only scan TypeScript files
      - '!test/**'     # Exclude test directories
      - '!docs/**'     # Exclude documentation
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday
  workflow_dispatch:
    inputs:
      severity_threshold:
        description: 'Minimum severity to fail build (info, low, medium, high, critical)'
        required: false
        default: 'high'
        type: choice
        options:
          - info
          - low
          - medium
          - high
          - critical

env:
  REPOGUARD_SEVERITY_THRESHOLD: ${{ github.event.inputs.severity_threshold || 'high' }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      security-events: write  # For GitHub Security tab integration

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git scanning

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install RepoGuard CLI
      run: |
        pip install repoguard-cli

    - name: Create custom RepoGuard config
      run: |
        cat > repoguard-config.json << EOF
        {
          "exclude_patterns": [
            "test/**",
            "tests/**",
            "**/*.test.*",
            "**/*.spec.*",
            "node_modules/**",
            ".git/**",
            "dist/**",
            "build/**"
          ],
          "severity_threshold": "${{ env.REPOGUARD_SEVERITY_THRESHOLD }}",
          "enable_git_history_scan": true,
          "max_file_size_mb": 10,
          "scan_timeout_seconds": 300,
          "custom_rules": []
        }
        EOF

    - name: Run RepoGuard Security Scan
      id: repoguard-scan
      run: |
        repoguard scan --repo . --format json --config repoguard-config.json
        echo "scan_exit_code=$?" >> $GITHUB_OUTPUT

    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: repoguard-security-report-${{ github.run_id }}
        path: repoguard-report.json
        retention-days: 90  # Keep longer for compliance

    - name: Upload SARIF Report for GitHub Security Tab
      if: always()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: repoguard-report.json
        category: repoguard-scan

    - name: Parse Security Results
      if: always()
      id: parse-results
      run: |
        if [ -f repoguard-report.json ]; then
          critical=$(jq '.scan_statistics.issues_critical // 0' repoguard-report.json)
          high=$(jq '.scan_statistics.issues_high // 0' repoguard-report.json)
          medium=$(jq '.scan_statistics.issues_medium // 0' repoguard-report.json)
          low=$(jq '.scan_statistics.issues_low // 0' repoguard-report.json)
          info=$(jq '.scan_statistics.issues_info // 0' repoguard-report.json)
          total=$(jq '.scan_statistics.total_issues // 0' repoguard-report.json)
          risk_level=$(jq -r '.scan_statistics.risk_level // "UNKNOWN"' repoguard-report.json)
          risk_score=$(jq '.scan_statistics.risk_score // 0' repoguard-report.json)

          echo "critical_issues=$critical" >> $GITHUB_OUTPUT
          echo "high_issues=$high" >> $GITHUB_OUTPUT
          echo "medium_issues=$medium" >> $GITHUB_OUTPUT
          echo "low_issues=$low" >> $GITHUB_OUTPUT
          echo "info_issues=$info" >> $GITHUB_OUTPUT
          echo "total_issues=$total" >> $GITHUB_OUTPUT
          echo "risk_level=$risk_level" >> $GITHUB_OUTPUT
          echo "risk_score=$risk_score" >> $GITHUB_OUTPUT
        fi

    - name: Generate Security Badge
      if: always()
      run: |
        risk_level="${{ steps.parse-results.outputs.risk_level }}"
        case $risk_level in
          "CRITICAL") color="red" ;;
          "HIGH") color="orange" ;;
          "MEDIUM") color="yellow" ;;
          "LOW") color="blue" ;;
          "INFO") color="green" ;;
          *) color="lightgrey" ;;
        esac

        # Create badge JSON for shields.io
        cat > security-badge.json << EOF
        {
          "schemaVersion": 1,
          "label": "Security Risk",
          "message": "$risk_level",
          "color": "$color",
          "style": "flat"
        }
        EOF

    - name: Comment on Pull Request
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('repoguard-report.json', 'utf8'));

          const { critical_issues, high_issues, medium_issues, low_issues, info_issues, total_issues, risk_level, risk_score } = {
            critical_issues: report.scan_statistics?.issues_critical || 0,
            high_issues: report.scan_statistics?.issues_high || 0,
            medium_issues: report.scan_statistics?.issues_medium || 0,
            low_issues: report.scan_statistics?.issues_low || 0,
            info_issues: report.scan_statistics?.issues_info || 0,
            total_issues: report.scan_statistics?.total_issues || 0,
            risk_level: report.scan_statistics?.risk_level || 'UNKNOWN',
            risk_score: report.scan_statistics?.risk_score || 0
          };

          let status = 'âœ…';
          let title = 'Security Scan Passed';
          let color = 'green';
          let shouldFail = false;

          const threshold = process.env.REPOGUARD_SEVERITY_THRESHOLD || 'high';

          if (risk_level === 'CRITICAL' || (threshold === 'high' && high_issues > 0) || (threshold === 'medium' && (high_issues > 0 || medium_issues > 0))) {
            status = 'ðŸš¨';
            title = 'Security Issues Require Attention';
            color = 'red';
            shouldFail = true;
          } else if (total_issues > 0) {
            status = 'âš ï¸';
            title = 'Security Issues Found';
            color = 'orange';
          }

          const findings = report.findings || {};
          const secretsCount = Object.keys(findings.secrets || []).length;
          const vulnerabilitiesCount = Object.keys(findings.vulnerabilities || []).length;

          const body = `
          ## ${status} ${title}

          **Risk Level:** ${risk_level} (Score: ${risk_score})
          **Total Issues:** ${total_issues}

          ### Issue Breakdown:
          - ðŸ”´ Critical: ${critical_issues}
          - ðŸŸ  High: ${high_issues}
          - ðŸŸ¡ Medium: ${medium_issues}
          - ðŸ”µ Low: ${low_issues}
          - â„¹ï¸ Info: ${info_issues}

          ### Categories:
          - ðŸ” Secrets: ${secretsCount}
          - ðŸ›¡ï¸ Vulnerabilities: ${vulnerabilitiesCount}

          ### Configuration:
          - Severity Threshold: ${threshold}
          - Files Scanned: ${report.scan_statistics?.files_scanned || 0}
          - Lines Analyzed: ${report.scan_statistics?.lines_analyzed || 0}

          ðŸ“Š [View detailed report](${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}})

          ---
          *Automated security scanning by [RepoGuard](https://repoguard.dev)*
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

          // Set output for build failure decision
          process.stdout.write(`::set-output name=should_fail::${shouldFail}\n`);

    - name: Fail build based on security policy
      if: steps.pr-comment.outputs.should_fail == 'true'
      run: |
        echo "ðŸš¨ Build failed due to security policy violation"
        echo "Risk Level: ${{ steps.parse-results.outputs.risk_level }}"
        echo "Severity Threshold: ${{ env.REPOGUARD_SEVERITY_THRESHOLD }}"
        echo ""
        echo "To fix this:"
        echo "1. Review the security report in the PR comments"
        echo "2. Address critical and high-severity issues"
        echo "3. Commit the fixes and push to this branch"
        echo "4. The build will automatically re-run"
        exit 1

    - name: Security Metrics Report
      if: always()
      run: |
        echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Risk Level | ${{ steps.parse-results.outputs.risk_level }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Risk Score | ${{ steps.parse-results.outputs.risk_score }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Total Issues | ${{ steps.parse-results.outputs.total_issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Critical | ${{ steps.parse-results.outputs.critical_issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| High | ${{ steps.parse-results.outputs.high_issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Medium | ${{ steps.parse-results.outputs.medium_issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Files Scanned | $(jq '.scan_statistics.files_scanned // 0' repoguard-report.json) |" >> $GITHUB_STEP_SUMMARY
        echo "| Lines Analyzed | $(jq '.scan_statistics.lines_analyzed // 0' repoguard-report.json) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š [Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  # Compliance Check Job
  compliance-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    needs: security-scan

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate Compliance Report
      run: |
        echo "ðŸ“‹ Generating compliance report..."
        # This could integrate with compliance tools
        echo "Compliance check completed"

    - name: Upload Compliance Report
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance-report.json
        retention-days: 365  # Keep for audit purposes