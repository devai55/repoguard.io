name: Security Scan with RepoGuard

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full git history for historical secret scanning

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install RepoGuard CLI
      run: |
        pip install repoguard-cli

    - name: Run RepoGuard Security Scan
      id: repoguard-scan
      run: |
        # Run security scan and capture exit code
        repoguard scan --repo . --format json
        echo "scan_exit_code=$?" >> $GITHUB_OUTPUT

    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: repoguard-security-report
        path: repoguard-report.json
        retention-days: 30

    - name: Parse Security Results
      if: always()
      id: parse-results
      run: |
        if [ -f repoguard-report.json ]; then
          # Extract key metrics from JSON report
          critical=$(jq '.scan_statistics.issues_critical' repoguard-report.json)
          high=$(jq '.scan_statistics.issues_high' repoguard-report.json)
          medium=$(jq '.scan_statistics.issues_medium' repoguard-report.json)
          total=$(jq '.scan_statistics.total_issues' repoguard-report.json)
          risk_level=$(jq -r '.scan_statistics.risk_level' repoguard-report.json)

          echo "critical_issues=$critical" >> $GITHUB_OUTPUT
          echo "high_issues=$high" >> $GITHUB_OUTPUT
          echo "medium_issues=$medium" >> $GITHUB_OUTPUT
          echo "total_issues=$total" >> $GITHUB_OUTPUT
          echo "risk_level=$risk_level" >> $GITHUB_OUTPUT
        else
          echo "No report generated"
          exit 1
        fi

    - name: Comment on Pull Request
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const { critical_issues, high_issues, medium_issues, total_issues, risk_level } = process.env;

          let status = 'âœ…';
          let color = 'green';
          let message = '';

          if (risk_level === 'CRITICAL') {
            status = 'ðŸš¨';
            color = 'red';
            message = '**CRITICAL SECURITY ISSUES FOUND** - Review required before merge';
          } else if (risk_level === 'HIGH') {
            status = 'âš ï¸';
            color = 'orange';
            message = '**High severity issues detected** - Consider addressing before merge';
          } else if (total_issues > 0) {
            status = 'â„¹ï¸';
            color = 'blue';
            message = '**Security issues found** - Review recommended';
          } else {
            message = '**No security issues found** - Code looks secure!';
          }

          const body = `
          ## ${status} RepoGuard Security Scan Results

          **Risk Level:** ${risk_level}
          **Total Issues:** ${total_issues}

          ### Breakdown:
          - ðŸ”´ Critical: ${critical_issues}
          - ðŸŸ  High: ${high_issues}
          - ðŸŸ¡ Medium: ${medium_issues}

          ${message}

          ðŸ“Š [View detailed report](${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}})

          ---
          *This scan was performed by [RepoGuard](https://repoguard.dev) - Automated security scanning for modern development teams.*
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Fail build on critical issues
      if: steps.parse-results.outputs.risk_level == 'CRITICAL'
      run: |
        echo "ðŸš¨ CRITICAL security issues found! Failing build to prevent deployment."
        echo "Review the security report and fix critical issues before merging."
        exit 1

    - name: Security Scan Summary
      if: always()
      run: |
        echo "ðŸ” RepoGuard Security Scan Complete"
        echo "=================================="
        echo "Risk Level: ${{ steps.parse-results.outputs.risk_level }}"
        echo "Critical Issues: ${{ steps.parse-results.outputs.critical_issues }}"
        echo "High Issues: ${{ steps.parse-results.outputs.high_issues }}"
        echo "Medium Issues: ${{ steps.parse-results.outputs.medium_issues }}"
        echo "Total Issues: ${{ steps.parse-results.outputs.total_issues }}"
        echo ""
        echo "ðŸ“„ Full report available in artifacts: repoguard-security-report"

    - name: Notify on Critical Issues
      if: steps.parse-results.outputs.risk_level == 'CRITICAL'
      run: |
        echo "ðŸš¨ CRITICAL SECURITY ALERT ðŸš¨"
        echo "Critical security issues detected in ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.actor }}"
        echo ""
        echo "Action required: Review and fix critical security issues"
        echo "Report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # Optional: Separate job for dependency vulnerability scanning
  dependency-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        pip install repoguard-cli
        pip install safety  # For additional dependency scanning

    - name: Run Dependency Vulnerability Scan
      run: |
        echo "ðŸ” Scanning dependencies for vulnerabilities..."
        safety check --json > dependency-report.json || true

    - name: Upload Dependency Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-vulnerability-report
        path: dependency-report.json
        retention-days: 30